# Code adapted from https://github.com/astral-sh/uv-docker-example/blob/main/multistage.Dockerfile
# NOTE: --mount relies on BuildKit which is NOT usable with the deploy() command (using this Dockerfile as base image) for prefect v3 flows (prefect.utilities.dockerutils.BuildError: the --mount option requires BuildKit. Refer to https://docs.docker.com/go/buildkit/ to learn how to build images with BuildKit enabled)
# IIUC, this is due to a limitation of an underlying dependency: https://github.com/PrefectHQ/prefect/issues/12922
# Therefore, I piped the original code through an AI and had it genereate a new Dockerfile that does not use --mount, but instead uses COPY to copy the files into the image.
# ---- Stage 1: builder ----
FROM ghcr.io/astral-sh/uv:python3.13-bookworm-slim AS builder
ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy
ENV UV_PYTHON_DOWNLOADS=0

WORKDIR /app

# Step 1: Copy only dependency files first (for Docker cache optimization)
COPY pyproject.toml uv.lock ./

# Step 2: Install dependencies *only* (won't trigger cache bust if code changes)
RUN uv sync --locked --no-install-project --no-dev

# Step 3: Copy the rest of the project (your source code, etc.)
COPY . .

# Step 4: Install your code as a package with dependencies (no dev)
RUN uv sync --locked --no-dev

# ---- Stage 2: final ----
FROM python:3.13-slim-bookworm

# change to the worker dir
WORKDIR /app/workers/ai_image_detection

# Step 5: Copy the built virtualenv and source from builder
COPY --from=builder /app /app

# Step 6: Place executables at front of PATH
ENV PATH="/app/.venv/bin:$PATH"

# Step 7: Run uv run main.py on container start
CMD ["uv", "run", "main.py"]

